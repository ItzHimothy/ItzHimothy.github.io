<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>StudyPartner | AI Study Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-light: #f4f6fb;
      --glass-light: rgba(255, 255, 255, 0.7);
      --glass-dark: rgba(15, 23, 42, 0.65);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.25);
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --danger: #ef4444;
      --success: #22c55e;
      --border-light: rgba(148, 163, 184, 0.5);
      --border-dark: rgba(30, 64, 175, 0.8);
      --radius-xl: 20px;
      --radius-2xl: 28px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.25);
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.25s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000 100%);
      color: var(--text-dark);
    }

    body.light {
      background: radial-gradient(circle at top, #e0f2fe 0, #eff6ff 40%, #e5e7eb 100%);
      color: var(--text-light);
    }

    #app {
      width: 100%;
      max-width: 1100px;
      min-height: 100vh;
      padding: 16px 16px 82px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #a855f7 0, #1d4ed8 45%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 18px;
      box-shadow: var(--shadow-soft);
    }

    .logo-text-main {
      font-size: 18px;
      font-weight: 700;
    }

    .logo-text-sub {
      font-size: 11px;
      opacity: 0.75;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-dark);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.95));
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-dark);
    }

    body.light .pill {
      border-color: var(--border-light);
      background: linear-gradient(135deg, rgba(191, 219, 254, 0.9), rgba(239, 246, 255, 0.9));
      color: var(--text-light);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 13px rgba(34, 197, 94, 0.9);
    }

    .icon-btn {
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    body.light .icon-btn {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-light);
    }

    .icon-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.4);
    }

    .icon-btn span {
      font-size: 13px;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 12px;
      align-items: flex-start;
    }

    @media (max-width: 840px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
      #app {
        padding-bottom: 92px;
      }
    }

    .glass {
      border-radius: var(--radius-2xl);
      padding: 14px 16px;
      background: var(--glass-dark);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    body.light .glass {
      background: var(--glass-light);
      border-color: var(--border-light);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.18);
    }

    .glass::before {
      content: "";
      position: absolute;
      inset: -50%;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 60%);
      opacity: 0.8;
      pointer-events: none;
    }

    .glass-inner {
      position: relative;
      z-index: 1;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-sub {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
      color: #e5e7eb;
    }

    body.light .chip {
      background: rgba(255, 255, 255, 0.85);
      color: var(--text-light);
    }

    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .stat-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .stat-pill {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 5px 9px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      opacity: 0.7;
      font-size: 10px;
    }

    .stat-value {
      font-weight: 600;
    }

    .btn-primary,
    .btn-ghost,
    .btn-outline {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      box-shadow: 0 16px 40px rgba(56, 189, 248, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 50px rgba(56, 189, 248, 0.55);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: inherit;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.35);
    }

    body.light .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.9);
    }

    .btn-outline {
      border: 1px solid rgba(56, 189, 248, 0.8);
      background: transparent;
      color: #7dd3fc;
    }

    body.light .btn-outline {
      color: #0369a1;
      border-color: #0ea5e9;
    }

    .btn-outline:hover {
      background: rgba(56, 189, 248, 0.15);
    }

    .tag-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.18);
      color: #4ade80;
    }

    body.light .tag-badge {
      background: rgba(22, 163, 74, 0.06);
      color: #166534;
    }

    .muted {
      opacity: 0.65;
      font-size: 11px;
    }

    .hidden {
      display: none !important;
    }

    .tutor-chat {
      max-height: 260px;
      min-height: 180px;
      padding: 8px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.98));
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    body.light .tutor-chat {
      background: rgba(255, 255, 255, 0.9);
    }

    .msg {
      max-width: 80%;
      padding: 6px 9px;
      border-radius: 14px;
      line-height: 1.3;
      white-space: pre-wrap;
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #1d4ed8, #38bdf8);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg.ai {
      align-self: flex-start;
      background: rgba(15, 23, 42, 0.9);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(56, 189, 248, 0.3);
    }

    body.light .msg.ai {
      background: rgba(248, 250, 252, 0.98);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .msg-meta {
      font-size: 9px;
      opacity: 0.6;
      margin-bottom: 1px;
    }

    .tutor-input-row {
      display: flex;
      margin-top: 8px;
      gap: 6px;
      align-items: center;
    }

    .tutor-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: inherit;
      font-size: 12px;
      padding: 7px 10px;
      outline: none;
    }

    body.light .tutor-input-row input {
      background: rgba(255, 255, 255, 0.95);
    }

    .pill-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pill-suggestions button {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: transparent;
      font-size: 10px;
      color: inherit;
      cursor: pointer;
      opacity: 0.8;
    }

    .pill-suggestions button:hover {
      opacity: 1;
      background: rgba(15, 23, 42, 0.4);
    }

    body.light .pill-suggestions button:hover {
      background: rgba(255, 255, 255, 0.9);
    }

    .flashcard-box {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.98));
      padding: 12px;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    body.light .flashcard-box {
      background: rgba(255, 255, 255, 0.96);
    }

    .flashcard-front-label,
    .flashcard-back-label {
      font-size: 10px;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .flashcard-content {
      font-size: 13px;
      font-weight: 500;
    }

    .flashcard-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      font-size: 10px;
      opacity: 0.8;
    }

    .flashcard-actions {
      display: flex;
      gap: 6px;
    }

    .flashcard-actions button {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    .btn-know {
      background: rgba(34, 197, 94, 0.18);
      color: #4ade80;
    }

    .btn-dont-know {
      background: rgba(239, 68, 68, 0.14);
      color: #f97373;
    }

    body.light .btn-know {
      background: rgba(22, 163, 74, 0.06);
      color: #15803d;
    }

    body.light .btn-dont-know {
      background: rgba(248, 113, 113, 0.1);
      color: #b91c1c;
    }

    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .badge-green {
      border-color: rgba(34, 197, 94, 0.8);
      color: #4ade80;
      background: rgba(22, 163, 74, 0.1);
    }

    body.light .badge-green {
      background: rgba(22, 163, 74, 0.05);
      color: #166534;
    }

    .badge-red {
      border-color: rgba(239, 68, 68, 0.8);
      color: #fca5a5;
      background: rgba(127, 29, 29, 0.2);
    }

    .upload-zone {
      margin-top: 6px;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      padding: 10px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
    }

    .upload-zone strong {
      font-weight: 600;
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    .small-label {
      font-size: 10px;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .input-sm,
    select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 6px 9px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      color: inherit;
      outline: none;
    }

    body.light .input-sm,
    body.light select {
      background: rgba(255, 255, 255, 0.96);
    }

    textarea {
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 8px 10px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
      color: inherit;
      outline: none;
      resize: vertical;
      min-height: 80px;
    }

    body.light textarea {
      background: rgba(255, 255, 255, 0.96);
    }

    .media-preview {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 8px;
      font-size: 11px;
      max-height: 190px;
      overflow: auto;
    }

    .nav-bottom {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 1100px;
      padding: 0 16px;
      pointer-events: none;
    }

    .nav-inner {
      pointer-events: auto;
      border-radius: 999px;
      padding: 6px;
      background: rgba(15, 23, 42, 0.88);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(30, 64, 175, 0.7);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    body.light .nav-inner {
      background: rgba(255, 255, 255, 0.92);
      border-color: rgba(148, 163, 184, 0.6);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.25);
    }

    .nav-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 6px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: rgba(148, 163, 184, 0.9);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .nav-btn span {
      font-size: 14px;
    }

    .nav-btn.active {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.32), rgba(15, 23, 42, 0.95));
      color: #e0f2fe;
      transform: translateY(-1px);
    }

    body.light .nav-btn {
      color: rgba(100, 116, 139, 0.95);
    }

    body.light .nav-btn.active {
      background: linear-gradient(135deg, rgba(191, 219, 254, 0.9), rgba(59, 130, 246, 0.95));
      color: white;
    }

    .plan-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
    }

    body.light .plan-pill {
      background: rgba(219, 234, 254, 0.95);
      color: #0f172a;
    }

    .language-badge {
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 11px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.85);
    }

    body.light .language-badge {
      background: rgba(255, 255, 255, 0.95);
    }

    .switch {
      position: relative;
      width: 48px;
      height: 24px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.6);
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 0 2px;
    }

    body.light .switch {
      background: rgba(248, 250, 252, 0.98);
    }

    .switch-thumb {
      width: 19px;
      height: 19px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #e5e7eb, #94a3b8);
      transform: translateX(0);
      transition: transform 0.2s ease-out;
    }

    .switch-thumb.dark {
      transform: translateX(22px);
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 90px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border: 1px solid rgba(56, 189, 248, 0.6);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.5);
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      z-index: 999;
    }

    body.light .toast {
      background: rgba(255, 255, 255, 0.98);
      color: #0f172a;
      border-color: rgba(59, 130, 246, 0.8);
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
  </style>
</head>
<body class="dark" dir="ltr">
  <div id="app">
    <header>
      <div class="logo-area">
        <div class="logo-circle">SP</div>
        <div>
          <div class="logo-text-main" id="app-title">StudyPartner</div>
          <div class="logo-text-sub" id="app-subtitle">AI Tutor ‚Ä¢ Flashcards ‚Ä¢ PDF ‚Üí Q&A</div>
        </div>
      </div>
      <div class="header-right">
        <div class="plan-pill">
          <span id="plan-label">Free plan</span>
          <span style="font-size: 13px;">üíé</span>
        </div>
        <button class="language-badge" id="language-toggle">EN</button>
        <div class="switch" id="theme-toggle">
          <div class="switch-thumb" id="theme-thumb"></div>
        </div>
        <button class="icon-btn" id="login-btn">
          <span>üë§</span>
          <span id="login-label">Sign in</span>
        </button>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- LEFT: dashboard / tutor / flashcards -->
        <div>
          <!-- DASHBOARD SCREEN -->
          <section id="screen-dashboard" class="glass">
            <div class="glass-inner">
              <div class="flex-between">
                <div>
                  <div class="section-title">
                    <span>üìä Dashboard</span>
                  </div>
                  <div class="section-sub" id="dashboard-subtitle">
                    Your daily AI study overview
                  </div>
                </div>
                <button class="btn-outline" id="upgrade-btn">
                  <span>üöÄ</span>
                  <span id="upgrade-label">Upgrade plan</span>
                </button>
              </div>

              <div class="stat-row">
                <div class="stat-pill">
                  <div class="stat-label" id="credits-label">Weekly credits</div>
                  <div class="stat-value" id="credits-value">10 / 10</div>
                </div>
                <div class="stat-pill">
                  <div class="stat-label" id="questions-label">Tutor questions today</div>
                  <div class="stat-value" id="questions-value">0 / 3</div>
                </div>
              </div>

              <div style="margin-top:10px; display:flex; gap:8px;">
                <button class="btn-primary" id="go-tutor">
                  <span>üß†</span>
                  <span id="btn-tutor-label">Ask AI Tutor</span>
                </button>
                <button class="btn-ghost" id="go-flashcards">
                  <span>üìö</span>
                  <span id="btn-flashcards-label">Review flashcards</span>
                </button>
              </div>

              <div style="margin-top:8px;">
                <div class="section-sub" style="margin-bottom:4px;">
                  Quick actions
                </div>
                <div class="chip-row">
                  <button class="chip" id="quick-pdf">PDF ‚Üí Flashcards</button>
                  <button class="chip" id="quick-image">Generate diagram</button>
                  <button class="chip" id="quick-video">Explain in 60 seconds</button>
                </div>
              </div>
            </div>
          </section>

          <!-- TUTOR SCREEN -->
          <section id="screen-tutor" class="glass hidden">
            <div class="glass-inner">
              <div class="flex-between">
                <div>
                  <div class="section-title" id="tutor-title">
                    üß† AI Tutor
                  </div>
                  <div class="section-sub" id="tutor-subtitle">
                    Short, correct academic answers only ‚Äì math, science, medicine & more.
                  </div>
                </div>
                <span class="tag-badge" id="tutor-language-badge">Language: EN</span>
              </div>

              <div class="tutor-chat" id="tutor-chat"></div>

              <div class="pill-suggestions">
                <button data-suggest="Explain this step-by-step">Explain this</button>
                <button data-suggest="Give me an example.">Give an example</button>
                <button data-suggest="Solve this problem step-by-step.">Solve this step-by-step</button>
              </div>

              <div class="tutor-input-row">
                <input id="tutor-input" placeholder="Ask a question (no fluff, just academics)..." />
                <button class="btn-primary" id="tutor-send">
                  <span>‚û§</span>
                </button>
              </div>
              <div class="section-sub" style="margin-top:4px;">
                <span id="tutor-usage-text">Free: 3 questions/day. Each question uses 1 credit.</span>
              </div>
            </div>
          </section>

          <!-- FLASHCARDS SCREEN -->
          <section id="screen-flashcards" class="glass hidden">
            <div class="glass-inner">
              <div class="flex-between">
                <div>
                  <div class="section-title" id="flashcards-title">
                    üìö Flashcards
                  </div>
                  <div class="section-sub" id="flashcards-subtitle">
                    Review AI-generated or manual flashcards. Swipe mentally: know / don't know.
                  </div>
                </div>
                <span class="badge" id="flashcards-set-label">No set loaded</span>
              </div>

              <div class="flashcard-box">
                <div>
                  <div class="flashcard-front-label" id="flashcard-side-label">Front</div>
                  <div class="flashcard-content" id="flashcard-content">
                    No flashcards yet. Upload a PDF or create some using AI.
                  </div>
                </div>
                <div class="flashcard-footer">
                  <span id="flashcard-progress">0 / 0</span>
                  <div class="flashcard-actions">
                    <button class="btn-dont-know" id="flashcard-dontknow">Don‚Äôt know</button>
                    <button class="btn-know" id="flashcard-know">Know</button>
                    <button class="btn-ghost" id="flashcard-toggle">
                      Flip
                    </button>
                  </div>
                </div>
              </div>

              <div style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;">
                <button class="btn-ghost" id="flashcard-prev">‚óÄ Prev</button>
                <button class="btn-ghost" id="flashcard-next">Next ‚ñ∂</button>
                <button class="btn-primary" id="flashcard-new-manual">
                  ‚ûï New flashcard
                </button>
                <button class="btn-outline" id="flashcard-from-pdf">
                  üìÑ PDF ‚Üí AI flashcards
                </button>
              </div>
            </div>
          </section>
        </div>

        <!-- RIGHT: PDF, image, video, profile -->
        <div>
          <!-- PDF / FLASHCARDS GENERATION -->
          <section id="screen-create" class="glass">
            <div class="glass-inner">
              <div class="section-title" id="create-title">üìÑ PDF ‚Üí Flashcards</div>
              <div class="section-sub" id="create-subtitle">
                Upload a PDF, StudyPartner will detect key concepts and create Q&A flashcards.
              </div>

              <label class="upload-zone" id="pdf-drop-zone">
                <input type="file" id="pdf-input" accept=".pdf" />
                <span><strong>Click to select a PDF</strong> or drag & drop here.</span>
                <span class="muted">Free: 1 PDF/week. Student/Pro: unlimited.</span>
                <span class="muted" id="pdf-status">No file selected.</span>
              </label>

              <div style="margin-top:10px;">
                <div class="small-label">Generate in</div>
                <select id="pdf-language">
                  <option value="en">English</option>
                  <option value="ar">Arabic</option>
                </select>
              </div>

              <div style="margin-top:10px; display:flex; gap:6px;">
                <button class="btn-primary" id="pdf-generate-btn">
                  ‚ö° Generate flashcards
                </button>
                <button class="btn-ghost" id="pdf-clear-btn">
                  Reset
                </button>
              </div>

              <div class="media-preview" id="pdf-result-box" style="display:none;">
                <div class="small-label">Generated flashcard set title</div>
                <div id="pdf-result-title" style="font-size:12px; font-weight:600;"></div>
                <div class="small-label" style="margin-top:6px;">Preview (first 3 cards)</div>
                <ul id="pdf-result-preview" style="margin-top:4px; padding-left:15px; font-size:11px;"></ul>
              </div>
            </div>
          </section>

          <!-- IMAGE + VIDEO GENERATOR -->
          <section id="screen-media" class="glass" style="margin-top:12px;">
            <div class="glass-inner">
              <div class="section-title" id="media-title">
                üé® Image & üé• Video generator
              </div>
              <div class="section-sub" id="media-subtitle">
                Turn topics into diagrams, flashcard art, or 60-second explainers.
              </div>

              <div>
                <div class="small-label">Image prompt</div>
                <textarea id="image-prompt" placeholder="e.g., Labelled diagram of the nephron for medical students"></textarea>
                <div class="small-label" style="margin-top:4px;">Style</div>
                <select id="image-style">
                  <option value="diagram">Chart / Diagram</option>
                  <option value="biology">Labeled biology / chemistry</option>
                  <option value="cartoon">Cartoon illustration</option>
                  <option value="flashcard">Minimal flashcard illustration</option>
                  <option value="realistic">Realistic</option>
                </select>
                <button class="btn-primary" style="margin-top:6px;" id="image-generate-btn">
                  üé® Generate image
                </button>
              </div>

              <div style="margin-top:12px;">
                <div class="small-label">Video topic</div>
                <textarea id="video-topic" placeholder="e.g., Explain the cardiac cycle for grade 11 biology in 45‚Äì60 seconds"></textarea>
                <div class="small-label" style="margin-top:4px;">Style</div>
                <select id="video-style">
                  <option value="science">Science animation</option>
                  <option value="medical">Medical process steps</option>
                  <option value="math">Math problem walkthrough</option>
                  <option value="physics">Physics process</option>
                </select>
                <button class="btn-primary" style="margin-top:6px;" id="video-generate-btn">
                  üé• Generate explainer video
                </button>
              </div>

              <div class="media-preview" id="media-result" style="display:none;"></div>
            </div>
          </section>

          <!-- PROFILE / SETTINGS -->
          <section id="screen-profile" class="glass" style="margin-top:12px;">
            <div class="glass-inner">
              <div class="section-title" id="profile-title">
                ‚öôÔ∏è Profile & Settings
              </div>
              <div class="section-sub" id="profile-subtitle">
                Manage language, theme, and subscription.
              </div>

              <div style="margin-top:6px; font-size:12px;">
                <div><strong id="profile-user-email">Not signed in</strong></div>
                <div class="muted" id="profile-plan">Plan: Free</div>
              </div>

              <div style="margin-top:10px;">
                <div class="small-label">Language</div>
                <div style="display:flex; gap:6px;">
                  <button class="btn-ghost" id="lang-en-btn">English</button>
                  <button class="btn-ghost" id="lang-ar-btn">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
                </div>
              </div>

              <div style="margin-top:10px;">
                <div class="small-label">Theme</div>
                <div style="display:flex; gap:6px;">
                  <button class="btn-ghost" id="theme-light-btn">Light</button>
                  <button class="btn-ghost" id="theme-dark-btn">Dark</button>
                  <button class="btn-ghost" id="theme-system-btn">System</button>
                </div>
              </div>

              <div style="margin-top:10px;">
                <div class="small-label">Subscription</div>
                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                  <button class="btn-outline" id="sub-student-btn">Student ‚Äì AED 19</button>
                  <button class="btn-outline" id="sub-pro-btn">Pro ‚Äì AED 39</button>
                </div>
                <div class="muted" style="margin-top:4px;">
                  Payments handled securely via Stripe. No card data touches StudyPartner.
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Bottom navigation -->
  <div class="nav-bottom">
    <div class="nav-inner">
      <button class="nav-btn active" data-screen="dashboard">
        <span>üè†</span>
        <div id="nav-home-label">Home</div>
      </button>
      <button class="nav-btn" data-screen="tutor">
        <span>üß†</span>
        <div id="nav-tutor-label">Tutor</div>
      </button>
      <button class="nav-btn" data-screen="flashcards">
        <span>üìö</span>
        <div id="nav-cards-label">Cards</div>
      </button>
      <button class="nav-btn" data-screen="create">
        <span>‚ö°</span>
        <div id="nav-create-label">Create</div>
      </button>
      <button class="nav-btn" data-screen="profile">
        <span>‚öôÔ∏è</span>
        <div id="nav-profile-label">Profile</div>
      </button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase + Auth (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // üëâ REPLACE WITH YOUR REAL FIREBASE CONFIG (this is the one you showed)
    const firebaseConfig = {
      apiKey: "AIzaSyDSZsfIP19nrQvtY41o5ZgChNohp77clqw",
      authDomain: "flutter-ai-playground-af71f.firebaseapp.com",
      projectId: "flutter-ai-playground-af71f",
      storageBucket: "flutter-ai-playground-af71f.firebasestorage.app",
      messagingSenderId: "1061586855790",
      appId: "1:1061586855790:web:75e7a3f105f71b6257837f"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);

    // Expose minimal pieces to global script
    window._studyPartnerFirebase = {
      auth,
      db,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
    };
  </script>

  <!-- Main App Logic -->
  <script>
    // ==== CONFIG ‚Äì IMPORTANT ====
    // üëâ Change this to your backend URL (Render / Railway / Vercel / etc.)
    const API_BASE = "https://your-backend-domain.com"; // e.g., "https://studypartner-backend.onrender.com"

    // Stripe publishable key (safe to expose)
    const STRIPE_PUBLISHABLE_KEY = "pk_test_YOUR_STRIPE_PUBLISHABLE_KEY";

    // Price IDs you created in Stripe
    const STRIPE_PRICE_STUDENT = "price_1SZUKGBcqd4cRQjjllcnrA7u";
    const STRIPE_PRICE_PRO = "price_1SZUNgBcqd4cRQjjiz9RxYXY";

    // ==== STATE ====
    let currentUser = null;
    let userDoc = null;
    let currentLanguage = "en"; // "en" | "ar"
    let currentTheme = "dark";  // "dark" | "light"
    let tutorQuestionsToday = 0;
    let creditsRemaining = 10;
    let currentPlan = "free"; // "free" | "student" | "pro"

    let flashcardSets = []; // [{title, cards:[{front,back,mastered}]}]
    let activeSetIndex = -1;
    let activeCardIndex = 0;
    let showingBack = false;

    const {
      auth,
      db,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut,
      doc,
      getDoc,
      setDoc,
      updateDoc,
    } = window._studyPartnerFirebase;

    // ==== HELPERS ====
    function $(id) {
      return document.getElementById(id);
    }

    function showToast(msg) {
      const toast = $("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2600);
    }

    function setLanguage(lang) {
      currentLanguage = lang;
      document.body.dir = lang === "ar" ? "rtl" : "ltr";
      $("language-toggle").textContent = lang === "ar" ? "AR" : "EN";
      $("tutor-language-badge").textContent = lang === "ar" ? "ÿßŸÑŸÑÿ∫ÿ©: ÿßŸÑÿπÿ±ÿ®Ÿäÿ©" : "Language: EN";

      if (lang === "ar") {
        $("app-title").textContent = "ÿ≥ÿ™ÿØŸä ÿ®ÿßÿ±ÿ™ŸÜÿ±";
        $("app-subtitle").textContent = "ŸÖÿØÿ±ÿ≥ ÿ∞ŸÉŸä ‚Ä¢ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ™ÿπŸÑŸäŸÖŸäÿ© ‚Ä¢ PDF ÿ•ŸÑŸâ ÿ£ÿ≥ÿ¶ŸÑÿ©";
        $("dashboard-subtitle").textContent = "ŸÖŸÑÿÆÿµŸÉ ÿßŸÑŸäŸàŸÖŸä ŸÖÿπ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä.";
        $("btn-tutor-label").textContent = "ÿßÿ≥ÿ£ŸÑ ÿßŸÑŸÖÿØÿ±ÿ≥ ÿßŸÑÿ∞ŸÉŸä";
        $("btn-flashcards-label").textContent = "ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™";
        $("create-title").textContent = "üìÑ PDF ‚Üí ÿ®ÿ∑ÿßŸÇÿßÿ™";
        $("create-subtitle").textContent = "ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF Ÿàÿ≥Ÿäÿ≠ŸàŸëŸÑŸá ŸÑÿ£ÿ≥ÿ¶ŸÑÿ© Ÿàÿ£ÿ¨Ÿàÿ®ÿ© ŸÖÿÆÿ™ÿµÿ±ÿ©.";
        $("media-title").textContent = "üé® ÿµŸàÿ± Ÿà üé• ŸÅŸäÿØŸäŸàŸáÿßÿ™";
        $("media-subtitle").textContent = "ÿ≠ŸàŸëŸÑ ÿ£Ÿä ŸÖŸàÿ∂Ÿàÿπ ÿ•ŸÑŸâ ŸÖÿÆÿ∑ÿ∑ ÿ£Ÿà ŸÅŸäÿØŸäŸà ÿ¥ÿ±ÿ≠.";
        $("profile-title").textContent = "‚öôÔ∏è ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™";
        $("profile-subtitle").textContent = "ÿ∫ŸäŸëÿ± ÿßŸÑŸÑÿ∫ÿ©ÿå ÿßŸÑŸÖÿ∏Ÿáÿ±ÿå ŸàÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ.";
        $("nav-home-label").textContent = "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©";
        $("nav-tutor-label").textContent = "ÿßŸÑŸÖÿØÿ±ÿ≥";
        $("nav-cards-label").textContent = "ÿ®ÿ∑ÿßŸÇÿßÿ™";
        $("nav-create-label").textContent = "ÿ•ŸÜÿ¥ÿßÿ°";
        $("nav-profile-label").textContent = "ÿ≠ÿ≥ÿßÿ®Ÿä";
        $("upgrade-label").textContent = "ÿ™ÿ±ŸÇŸäÿ© ÿßŸÑÿÆÿ∑ÿ©";
      } else {
        $("app-title").textContent = "StudyPartner";
        $("app-subtitle").textContent = "AI Tutor ‚Ä¢ Flashcards ‚Ä¢ PDF ‚Üí Q&A";
        $("dashboard-subtitle").textContent = "Your daily AI study overview.";
        $("btn-tutor-label").textContent = "Ask AI Tutor";
        $("btn-flashcards-label").textContent = "Review flashcards";
        $("create-title").textContent = "üìÑ PDF ‚Üí Flashcards";
        $("create-subtitle").textContent = "Upload a PDF, StudyPartner creates concise Q&A cards.";
        $("media-title").textContent = "üé® Image & üé• Video generator";
        $("media-subtitle").textContent = "Turn topics into diagrams or short explainers.";
        $("profile-title").textContent = "‚öôÔ∏è Profile & Settings";
        $("profile-subtitle").textContent = "Manage language, theme, and subscription.";
        $("nav-home-label").textContent = "Home";
        $("nav-tutor-label").textContent = "Tutor";
        $("nav-cards-label").textContent = "Cards";
        $("nav-create-label").textContent = "Create";
        $("nav-profile-label").textContent = "Profile";
        $("upgrade-label").textContent = "Upgrade plan";
      }

      // TODO: optionally store language to Firestore for the user
      if (currentUser) {
        updateDoc(doc(db, "users", currentUser.uid), { language: lang }).catch(() => {});
      }
    }

    function setTheme(theme) {
      currentTheme = theme;
      const thumb = $("theme-thumb");
      if (theme === "dark") {
        document.body.classList.remove("light");
        thumb.classList.add("dark");
      } else {
        document.body.classList.add("light");
        thumb.classList.remove("dark");
      }
    }

    function setPlan(plan) {
      currentPlan = plan;
      let label = "Free plan";
      if (plan === "student") label = "Student";
      if (plan === "pro") label = "Pro";
      $("plan-label").textContent = label;
      $("profile-plan").textContent = "Plan: " + label;
    }

    function updateUsageUI() {
      $("credits-value").textContent = `${creditsRemaining} / 10`;
      $("questions-value").textContent = `${tutorQuestionsToday} / ${
        currentPlan === "free" ? 3 : currentPlan === "student" ? 20 : "‚àû"
      }`;
    }

    function switchScreen(name) {
      const map = {
        dashboard: "screen-dashboard",
        tutor: "screen-tutor",
        flashcards: "screen-flashcards",
        create: "screen-create",
        profile: "screen-profile",
      };
      for (const key in map) {
        $(map[key]).classList.add("hidden");
      }
      $(map[name]).classList.remove("hidden");
      document.querySelectorAll(".nav-btn").forEach(btn => {
        if (btn.dataset.screen === name) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    // ==== FLASHCARDS ====
    function loadFlashcardUI() {
      if (activeSetIndex < 0 || !flashcardSets[activeSetIndex]) {
        $("flashcard-content").textContent = currentLanguage === "ar"
          ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ®ÿπÿØ. ÿßÿ±ŸÅÿπ PDF ÿ£Ÿà ÿ£ŸÜÿ¥ÿ¶ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ¨ÿØŸäÿØÿ©."
          : "No flashcards yet. Upload a PDF or create some using AI.";
        $("flashcards-set-label").textContent = currentLanguage === "ar"
          ? "ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ ŸÖÿÆÿ™ÿßÿ±"
          : "No set loaded";
        $("flashcard-progress").textContent = "0 / 0";
        return;
      }
      const set = flashcardSets[activeSetIndex];
      const cards = set.cards;
      if (cards.length === 0) {
        $("flashcard-content").textContent = currentLanguage === "ar"
          ? "Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫."
          : "This set has no cards yet.";
        $("flashcard-progress").textContent = "0 / 0";
        return;
      }
      if (activeCardIndex >= cards.length) activeCardIndex = 0;
      const card = cards[activeCardIndex];
      $("flashcards-set-label").textContent = set.title;
      $("flashcard-progress").textContent = `${activeCardIndex + 1} / ${cards.length}`;
      $("flashcard-side-label").textContent = showingBack ? "Back" : "Front";
      $("flashcard-content").textContent = showingBack ? card.back : card.front;
    }

    function addMockSet() {
      // simple starter set
      flashcardSets = [
        {
          title: "Demo ‚Äì StudyPartner basics",
          cards: [
            { front: "What does StudyPartner do?", back: "AI tutor + flashcards + PDF ‚Üí Q&A + images/videos.", mastered: false },
            { front: "What languages are supported?", back: "English + Arabic (UI + answers).", mastered: false },
            { front: "How are limits enforced?", back: "Via plan type (Free/Student/Pro) + credits in backend.", mastered: false },
          ],
        },
      ];
      activeSetIndex = 0;
      activeCardIndex = 0;
      showingBack = false;
      loadFlashcardUI();
    }

    // ==== API CALL HELPERS ====
    async function callBackend(path, payload, isFormData = false) {
      try {
        const res = await fetch(API_BASE + path, {
          method: "POST",
          headers: isFormData ? undefined : { "Content-Type": "application/json" },
          body: isFormData ? payload : JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Request failed");
        }
        return await res.json();
      } catch (err) {
        console.error("API error:", err);
        showToast(err.message || "Server error");
        throw err;
      }
    }

    // ==== TUTOR HANDLERS ====
    function appendTutorMessage(role, content) {
      const chat = $("tutor-chat");
      const wrapper = document.createElement("div");
      wrapper.className = "msg " + (role === "user" ? "user" : "ai");
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent =
        role === "user" ? (currentLanguage === "ar" ? "ÿ£ŸÜÿ™" : "You") : (currentLanguage === "ar" ? "ÿßŸÑŸÖÿØÿ±ÿ≥" : "Tutor");
      const body = document.createElement("div");
      body.textContent = content;
      wrapper.appendChild(meta);
      wrapper.appendChild(body);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
    }

    async function askTutor() {
      const input = $("tutor-input");
      const text = input.value.trim();
      if (!text) return;
      if (!currentUser) {
        showToast(currentLanguage === "ar" ? "ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã." : "Please sign in first.");
        return;
      }
      appendTutorMessage("user", text);
      input.value = "";
      $("tutor-input").disabled = true;
      $("tutor-send").disabled = true;

      try {
        const res = await callBackend("/api/askTutor", {
          userId: currentUser.uid,
          language: currentLanguage,
          message: text,
        });
        const answer = res.answer || (currentLanguage === "ar" ? "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ±ÿØ." : "Error in tutor answer.");
        appendTutorMessage("assistant", answer);
        tutorQuestionsToday = res.questionsUsedToday ?? tutorQuestionsToday + 1;
        creditsRemaining = res.creditsRemaining ?? creditsRemaining - 1;
        updateUsageUI();
      } catch (_) {
        appendTutorMessage(
          "assistant",
          currentLanguage === "ar"
            ? "ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÖÿØÿ±ÿ≥ ÿ≠ÿßŸÑŸäÿßŸã. ÿ¨ÿ±Ÿëÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑÿßÿ≠ŸÇÿßŸã."
            : "Tutor is unavailable right now. Please try again later."
        );
      } finally {
        $("tutor-input").disabled = false;
        $("tutor-send").disabled = false;
        $("tutor-input").focus();
      }
    }

    // ==== PDF HANDLERS ====
    let selectedPdfFile = null;

    function setupPdfDropzone() {
      const zone = $("pdf-drop-zone");
      const input = $("pdf-input");

      zone.addEventListener("click", () => input.click());
      input.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.name.toLowerCase().endsWith(".pdf")) {
          showToast("Please select a PDF file.");
          return;
        }
        selectedPdfFile = file;
        $("pdf-status").textContent = "Selected: " + file.name;
      });

      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.style.borderColor = "#38bdf8";
      });
      zone.addEventListener("dragleave", () => {
        zone.style.borderColor = "rgba(148,163,184,0.6)";
      });
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.style.borderColor = "rgba(148,163,184,0.6)";
        const file = e.dataTransfer.files[0];
        if (!file) return;
        if (!file.name.toLowerCase().endsWith(".pdf")) {
          showToast("Please drop a PDF file.");
          return;
        }
        selectedPdfFile = file;
        $("pdf-status").textContent = "Selected: " + file.name;
      });
    }

    async function generateFlashcardsFromPdf() {
      if (!currentUser) {
        showToast(currentLanguage === "ar" ? "ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã." : "Please sign in first.");
        return;
      }
      if (!selectedPdfFile) {
        showToast(currentLanguage === "ar" ? "ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ PDF ÿ£ŸàŸÑÿßŸã." : "Select a PDF file first.");
        return;
      }

      $("pdf-generate-btn").disabled = true;
      $("pdf-generate-btn").textContent = currentLanguage === "ar" ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°..." : "Generating...";
      try {
        const formData = new FormData();
        formData.append("userId", currentUser.uid);
        formData.append("language", $("pdf-language").value);
        formData.append("pdfFile", selectedPdfFile);

        const res = await callBackend("/api/pdfToFlashcards", formData, true);
        const title = res.title || selectedPdfFile.name.replace(/\.pdf$/i, "");
        const cards = res.flashcards || [];
        if (cards.length === 0) {
          showToast(currentLanguage === "ar" ? "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿßÿ™." : "No flashcards were generated.");
          return;
        }

        flashcardSets.push({ title, cards });
        activeSetIndex = flashcardSets.length - 1;
        activeCardIndex = 0;
        showingBack = false;
        loadFlashcardUI();

        $("pdf-result-box").style.display = "block";
        $("pdf-result-title").textContent = title;
        const list = $("pdf-result-preview");
        list.innerHTML = "";
        cards.slice(0, 3).forEach((c) => {
          const li = document.createElement("li");
          li.textContent = `${c.front} ‚Üí ${c.back}`;
          list.appendChild(li);
        });

        showToast(currentLanguage === "ar" ? "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™." : "Flashcards generated.");
      } catch (_) {
      } finally {
        $("pdf-generate-btn").disabled = false;
        $("pdf-generate-btn").textContent = currentLanguage === "ar" ? "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™" : "Generate flashcards";
      }
    }

    // ==== IMAGE & VIDEO HANDLERS ====
    async function generateImage() {
      if (!currentUser) {
        showToast(currentLanguage === "ar" ? "ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã." : "Please sign in first.");
        return;
      }
      const prompt = $("image-prompt").value.trim();
      if (!prompt) {
        showToast(currentLanguage === "ar" ? "ÿßŸÉÿ™ÿ® ŸàÿµŸÅ ÿßŸÑÿµŸàÿ±ÿ©." : "Write an image prompt first.");
        return;
      }
      const style = $("image-style").value;
      $("image-generate-btn").disabled = true;
      $("image-generate-btn").textContent = currentLanguage === "ar" ? "ÿ¨ÿßÿ±Ÿç ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ©..." : "Generating image...";

      try {
        const res = await callBackend("/api/generateImage", {
          userId: currentUser.uid,
          prompt,
          style,
        });
        const url = res.imageURL;
        const box = $("media-result");
        box.style.display = "block";
        box.innerHTML = "";
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Generated image";
        img.style.maxWidth = "100%";
        img.style.borderRadius = "12px";
        box.appendChild(img);
      } catch (_) {
      } finally {
        $("image-generate-btn").disabled = false;
        $("image-generate-btn").textContent = currentLanguage === "ar" ? "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ©" : "Generate image";
      }
    }

    async function generateVideo() {
      if (!currentUser) {
        showToast(currentLanguage === "ar" ? "ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã." : "Please sign in first.");
        return;
      }
      const topic = $("video-topic").value.trim();
      if (!topic) {
        showToast(currentLanguage === "ar" ? "ÿßŸÉÿ™ÿ® ŸÖŸàÿ∂Ÿàÿπ ÿßŸÑŸÅŸäÿØŸäŸà." : "Write a video topic first.");
        return;
      }
      const style = $("video-style").value;
      $("video-generate-btn").disabled = true;
      $("video-generate-btn").textContent =
        currentLanguage === "ar" ? "ÿ¨ÿßÿ±Ÿç ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸäÿØŸäŸà..." : "Generating video...";

      try {
        const res = await callBackend("/api/generateVideo", {
          userId: currentUser.uid,
          topic,
          style,
          language: currentLanguage,
        });
        const url = res.videoURL;
        const box = $("media-result");
        box.style.display = "block";
        box.innerHTML = "";
        const link = document.createElement("a");
        link.href = url;
        link.target = "_blank";
        link.textContent = currentLanguage === "ar"
          ? "ŸÅÿ™ÿ≠ ÿßŸÑŸÅŸäÿØŸäŸà ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©"
          : "Open generated video in a new tab";
        box.appendChild(link);
      } catch (_) {
      } finally {
        $("video-generate-btn").disabled = false;
        $("video-generate-btn").textContent =
          currentLanguage === "ar" ? "ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸäÿØŸäŸà" : "Generate video";
      }
    }

    // ==== STRIPE CHECKOUT HELPERS ====
    async function startCheckout(priceId) {
      if (!currentUser) {
        showToast(currentLanguage === "ar" ? "ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã." : "Please sign in first.");
        return;
      }
      try {
        const res = await callBackend("/api/createCheckoutSession", {
          userId: currentUser.uid,
          priceId,
        });
        if (res.url) {
          window.location.href = res.url;
        } else {
          showToast("Unable to start checkout.");
        }
      } catch (_) {}
    }

    // ==== AUTH & USER PROFILE ====
    function updateUiForUser() {
      if (!currentUser) {
        $("login-label").textContent = currentLanguage === "ar" ? "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ" : "Sign in";
        $("profile-user-email").textContent = currentLanguage === "ar" ? "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸëŸÑ" : "Not signed in";
        setPlan("free");
        creditsRemaining = 10;
        tutorQuestionsToday = 0;
        updateUsageUI();
        return;
      }
      $("login-label").textContent = currentLanguage === "ar" ? "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨" : "Sign out";
      $("profile-user-email").textContent = currentUser.email || currentUser.displayName || "User";

      if (!userDoc) {
        // no doc yet ‚Äì create basic profile
        setDoc(doc(db, "users", currentUser.uid), {
          email: currentUser.email,
          planType: "free",
          language: currentLanguage,
          credits: 10,
          createdAt: new Date().toISOString(),
        }).catch(() => {});
        setPlan("free");
        creditsRemaining = 10;
      } else {
        const data = userDoc;
        setPlan(data.planType || "free");
        currentLanguage = data.language || "en";
        creditsRemaining = data.credits ?? 10;
      }
      updateUsageUI();
      setLanguage(currentLanguage);
    }

    async function fetchUserDoc(uid) {
      try {
        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists()) {
          userDoc = snap.data();
        } else {
          userDoc = null;
        }
      } catch (err) {
        console.error("Error fetching user doc", err);
      }
      updateUiForUser();
    }

    async function handleLoginClick() {
      if (currentUser) {
        // sign out
        await signOut(auth);
        currentUser = null;
        userDoc = null;
        updateUiForUser();
        showToast(currentLanguage === "ar" ? "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨." : "Signed out.");
        return;
      }
      // sign in with Google
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        await fetchUserDoc(currentUser.uid);
        showToast(currentLanguage === "ar" ? "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ." : "Signed in.");
      } catch (err) {
        console.error("Login error", err);
        showToast(err.message || "Login failed.");
      }
    }

    // ==== EVENT LISTENERS ====
    function initUiEvents() {
      // Nav
      document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          switchScreen(btn.dataset.screen);
        });
      });

      // Header controls
      $("login-btn").addEventListener("click", handleLoginClick);
      $("language-toggle").addEventListener("click", () => {
        setLanguage(currentLanguage === "en" ? "ar" : "en");
      });

      $("theme-toggle").addEventListener("click", () => {
        setTheme(currentTheme === "dark" ? "light" : "dark");
      });

      $("theme-light-btn").addEventListener("click", () => setTheme("light"));
      $("theme-dark-btn").addEventListener("click", () => setTheme("dark"));
      $("theme-system-btn").addEventListener("click", () => {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        setTheme(prefersDark ? "dark" : "light");
      });

      $("lang-en-btn").addEventListener("click", () => setLanguage("en"));
      $("lang-ar-btn").addEventListener("click", () => setLanguage("ar"));

      // Quick actions
      $("go-tutor").addEventListener("click", () => switchScreen("tutor"));
      $("go-flashcards").addEventListener("click", () => switchScreen("flashcards"));
      $("quick-pdf").addEventListener("click", () => switchScreen("create"));
      $("quick-image").addEventListener("click", () => switchScreen("create"));
      $("quick-video").addEventListener("click", () => switchScreen("create"));

      // Tutor
      $("tutor-send").addEventListener("click", askTutor);
      $("tutor-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") askTutor();
      });
      document.querySelectorAll(".pill-suggestions button").forEach(btn => {
        btn.addEventListener("click", () => {
          $("tutor-input").value = btn.dataset.suggest;
          $("tutor-input").focus();
        });
      });

      // Flashcards
      $("flashcard-toggle").addEventListener("click", () => {
        showingBack = !showingBack;
        loadFlashcardUI();
      });
      $("flashcard-next").addEventListener("click", () => {
        if (activeSetIndex < 0) return;
        const set = flashcardSets[activeSetIndex];
        if (!set) return;
        activeCardIndex = (activeCardIndex + 1) % set.cards.length;
        showingBack = false;
        loadFlashcardUI();
      });
      $("flashcard-prev").addEventListener("click", () => {
        if (activeSetIndex < 0) return;
        const set = flashcardSets[activeSetIndex];
        if (!set) return;
        activeCardIndex = (activeCardIndex - 1 + set.cards.length) % set.cards.length;
        showingBack = false;
        loadFlashcardUI();
      });

      $("flashcard-know").addEventListener("click", () => {
        if (activeSetIndex < 0) return;
        const set = flashcardSets[activeSetIndex];
        if (!set) return;
        set.cards[activeCardIndex].mastered = true;
        showToast(currentLanguage === "ar" ? "üëç ŸÖŸÖÿ™ÿßÿ≤!" : "üëç Marked as known!");
        $("flashcard-next").click();
      });

      $("flashcard-dontknow").addEventListener("click", () => {
        showToast(currentLanguage === "ar" ? "üôÇ ÿßÿ≥ÿ™ŸÖÿ± ÿ®ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©." : "üôÇ Keep reviewing.");
        $("flashcard-next").click();
      });

      $("flashcard-new-manual").addEventListener("click", () => {
        const front = prompt(currentLanguage === "ar" ? "ŸÜÿµ ÿßŸÑÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ©:" : "Front text:");
        if (!front) return;
        const back = prompt(currentLanguage === "ar" ? "ŸÜÿµ ÿßŸÑÿ¨Ÿáÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ©:" : "Back text:");
        if (!back) return;
        if (activeSetIndex < 0) {
          flashcardSets.push({ title: "Manual set", cards: [] });
          activeSetIndex = 0;
        }
        flashcardSets[activeSetIndex].cards.push({ front, back, mastered: false });
        activeCardIndex = flashcardSets[activeSetIndex].cards.length - 1;
        showingBack = false;
        loadFlashcardUI();
        showToast(currentLanguage === "ar" ? "ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©." : "Flashcard added.");
      });

      $("flashcard-from-pdf").addEventListener("click", () => switchScreen("create"));

      // PDF
      setupPdfDropzone();
      $("pdf-generate-btn").addEventListener("click", generateFlashcardsFromPdf);
      $("pdf-clear-btn").addEventListener("click", () => {
        selectedPdfFile = null;
        $("pdf-input").value = "";
        $("pdf-status").textContent = currentLanguage === "ar" ? "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ." : "No file selected.";
        $("pdf-result-box").style.display = "none";
      });

      // Media
      $("image-generate-btn").addEventListener("click", generateImage);
      $("video-generate-btn").addEventListener("click", generateVideo);

      // Subscription buttons
      $("upgrade-btn").addEventListener("click", () => switchScreen("profile"));
      $("sub-student-btn").addEventListener("click", () => startCheckout(STRIPE_PRICE_STUDENT));
      $("sub-pro-btn").addEventListener("click", () => startCheckout(STRIPE_PRICE_PRO));
    }

    // ==== INIT ====
    function initApp() {
      setTheme("dark");
      setLanguage("en");
      addMockSet();
      updateUsageUI();
      initUiEvents();

      onAuthStateChanged(auth, async (user) => {
        currentUser = user || null;
        if (currentUser) {
          await fetchUserDoc(currentUser.uid);
        } else {
          userDoc = null;
          updateUiForUser();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
